name: Build Floating Window APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          libssl-dev \
          libffi-dev \
          libxml2-dev \
          libxslt1-dev \
          libjpeg-dev \
          libpng-dev \
          zlib1g-dev \
          autotools-dev \
          autoconf \
          libtool \
          pkg-config \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython kivy numpy pillow opencv-python

    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: buildozer-global-${{ hashFiles('buildozer.spec') }}

    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: buildozer-${{ hashFiles('buildozer.spec') }}

    - name: Verify project files
      run: |
        echo "Checking project files..."
        ls -la
        echo "Checking floating_main.py..."
        if [ -f "floating_main.py" ]; then
          echo "âœ“ floating_main.py found"
        else
          echo "âœ— floating_main.py not found"
          exit 1
        fi
        echo "Checking mobile_game_engine.py..."
        if [ -f "mobile_game_engine.py" ]; then
          echo "âœ“ mobile_game_engine.py found"
        else
          echo "âœ— mobile_game_engine.py not found"
          exit 1
        fi
        echo "Checking buildozer.spec..."
        if [ -f "buildozer.spec" ]; then
          echo "âœ“ buildozer.spec found"
        else
          echo "âœ— buildozer.spec not found"
          exit 1
        fi

    - name: Create model directory
      run: |
        mkdir -p model
        if [ ! -f "model/best.pt" ]; then
          echo "Creating empty model file..."
          touch model/best.pt
        fi

    - name: Build with Buildozer
      run: |
        # Accept Android SDK licenses
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

        # Build the APK
        buildozer android debug

    - name: List build output
      run: |
        echo "Build completed. Checking output..."
        ls -la
        if [ -d "bin" ]; then
          echo "bin directory contents:"
          ls -la bin/
        else
          echo "bin directory not found"
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: mhcs-floating-apk
        path: bin/*.apk
        if-no-files-found: error

    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: floating-v${{ github.run_number }}
        name: æ»¡æ±‰åŠ©æ‰‹æ‚¬æµ®çª—ç‰ˆæœ¬ v${{ github.run_number }}
        body: |
          ## æ»¡æ±‰åŠ©æ‰‹æ‚¬æµ®çª—ç‰ˆæœ¬

          ### ç‰¹æ€§
          - ğŸ¯ æç®€æ‚¬æµ®çª—ç•Œé¢ (180x120åƒç´ )
          - âœ… å®Œæ•´ä¿ç•™åŸç‰ˆç®—æ³•
          - ğŸ® ä¸€é”®å¼€å§‹/æš‚åœæ§åˆ¶
          - ğŸ“Š å®æ—¶çŠ¶æ€æ˜¾ç¤º
          - ğŸ“± è‡ªé€‚åº”æ‰‹æœºåˆ†è¾¨ç‡

          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶å®‰è£…APK
          2. å¯ç”¨æ— éšœç¢æœåŠ¡æƒé™
          3. æ‰“å¼€æ¸¸æˆï¼Œç‚¹å‡»æ‚¬æµ®çª—"å¼€å§‹"æŒ‰é’®
          4. äº«å—è‡ªåŠ¨åŒ–æ¸¸æˆä½“éªŒ

          ### æ³¨æ„äº‹é¡¹
          - éœ€è¦Android 5.0+
          - å»ºè®®è®¾å¤‡RAM â‰¥ 2GB
          - è¯·åˆç†ä½¿ç”¨ï¼Œéµå®ˆæ¸¸æˆæœåŠ¡æ¡æ¬¾
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
